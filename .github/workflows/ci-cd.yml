name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test-backend:
    name: üß™ Backend Tests
    runs-on: ubuntu-latest
    
    
    env:
      # Indica ambiente de CI/Testes
      CI: true
      TESTING: true
      
      # Credenciais fake para EmailService (n√£o ser√£o usadas)
      SENDGRID_API_KEY: "SG.fake-key-for-testing-only"
      SENDER_EMAIL: "noreply@test.lmconciliation.com"
      SENDER_NAME: "LM Conciliation Test"
      FRONTEND_URL: "http://localhost:5173"
      
      # Configura√ß√µes do banco de dados de teste
      DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/lm_conciliation_test"
      
      # JWT/Auth configs
      SECRET_KEY: "test-secret-key-for-ci-cd-only-not-for-production"
      ALGORITHM: "HS256"
      ACCESS_TOKEN_EXPIRE_MINUTES: "30"
    
    # ervi√ßo PostgreSQL para testes
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: lm_conciliation_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock pytest-asyncio
    
    - name: Run tests with coverage
      run: |
        cd backend
        pytest tests/ -v \
          --cov=app \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-report=html \
          --cov-fail-under=75
    
    - name: Upload coverage to Codecov (opcional)
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage
        fail_ci_if_error: false
    
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage
        path: |
          backend/coverage.xml
          backend/htmlcov/

  sonarcloud:
    name: üîç SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test-backend
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Download coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage
        path: backend/
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

test-frontend:
    name: üß™ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run tests with coverage
      run: |
        cd frontend
        npm run test:coverage
    
    - name: Check coverage threshold
      run: |
        cd frontend
        COVERAGE=$(grep -Po '"lines":\{"total":\K[0-9.]+' coverage/coverage-summary.json || echo "0")
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 25" | bc -l) )); then
          echo "‚ùå Coverage is below 25%"
          exit 1
        fi
        echo "‚úÖ Coverage is above 25%"
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: frontend/coverage/

  build-frontend:
    name: üé® Build Frontend
    runs-on: ubuntu-latest
    needs: test-frontend     

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Build
      run: |
        cd frontend
        npm run build
      env:
        # Vari√°veis para build do frontend (se necess√°rio)
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.lmconciliation.com' }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist

  deploy-backend:
    name: üöÄ Deploy Backend
    runs-on: ubuntu-latest
    needs: [test-backend, sonarcloud]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/lm-conciliation
          git pull origin main
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --upgrade
          
          # Atualizar vari√°veis de ambiente (.env)
          sudo systemctl restart lm-conciliation
          
          # Verificar se o servi√ßo est√° rodando
          sleep 5
          curl -f http://localhost:8000/health || exit 1
          
          echo "‚úÖ Backend deployed successfully!"
  
  deploy-frontend:
    name: üöÄ Deploy Frontend
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist
    
    - name: Deploy to S3
      uses: jakejarvis/s3-sync-action@master
      with:
        args: --delete
      env:
        AWS_S3_BUCKET: lm-conciliation-frontend
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: 'sa-east-1'
        SOURCE_DIR: 'frontend/dist'
    
    - name: Invalidate CloudFront cache (se usar CDN)
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
          --paths "/*" || echo "‚ö†Ô∏è CloudFront invalidation skipped (not configured)"
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: 'sa-east-1'
      continue-on-error: true

  # Job extra: Badge de status
  status-badge:
    name: üìä Update Status Badge
    runs-on: ubuntu-latest
    needs: [test-backend, build-frontend]
    if: always()
    
    steps:
    - name: Create status badge
      run: |
        echo "Pipeline status: ${{ needs.test-backend.result }}"
        echo "Coverage uploaded successfully"
